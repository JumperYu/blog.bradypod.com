<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>html5俄罗斯方块-树懒博客-BradyPod's Blog</title>
  <meta name="description" content="树懒博客；BradyPod's Blog;89后，工作在广州；Java程序员。">
  <meta name="keywords" content="java, linux, shell, nginx, lua, mysql, memcached, redis">
  <meta name="author" content="bradypod">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="favicon.ico" type="image/ico" rel="icon">
  <link href="favicon.ico" type="image/ico" rel="shortcut icon">

  <link rel="canonical" href="http://blog.bradypod.com/">
  <link rel="stylesheet" href="/static/css/bootstrap.min.css" media="all">
  <link rel="stylesheet" href="/static/css/font-awesome.min.css" media="all">
  <link rel="stylesheet" href="/static/css/style.css" media="all">
  <link rel="stylesheet" href="/static/css/desert.css" media="all">
  <link rel="stylesheet" href="/static/css/2015_02_01_style.css" media="all">
 </head>
<body onload="prettyPrint()">
	<div class="container">

    <header class="header">
      <div class="title"><a title="bradypod's blog" href="/">BradyPod's blog</a></div>
      <ul class="nav navbar-nav navbar-right visible-lg visible-md">
        <li>
          <form id="search-form" class="form-group has-success visible-lg" role="form">
            <input type="text" class="form-control input-sm" placeholder="Search" id="query" style="width: 110px;">
          </form>
        </li>
        <li><a href="https://github.com/JumperYu" title="我的github主页"><i class="icon-github"></i> github</a></li>
        <li><a href="http://weibo.com/javaserverfaces/home?wvr=5" title="我的微博主页"><i class="icon-pinterest-sign"></i> weibo</a></li>
        <li><a href="index.html" title="联系我"><i class="icon-phone"></i> telphone</a></li>
      </ul>
    </header>
    <div class="wrapper">
		<div class="row">
        <div class="col-md-12">
          <article class="news-item">
  		    <h1>利用html5的canvas制作俄罗斯方块小游戏</h1>
          <p><h3>上一篇，实践了<a href="/2015/01/21/snake.html" target="_blank">《html5贪吃蛇》</a></h3></p>
  		    </aritcle>
<div>

</div><!-- end pretty div -->
          
      <div class="mycanvas">
            <canvas id="board">Your browser doesn't support Canvas</canvas>
      </div>
         
        </div><!-- end col md 12 div -->
    </div><!-- end row -->
    </div><!-- end wrapper -->
    <footer class="footer text-center">
        <p>&copy; 2014-2016 <a href="/" target="_blank" title="89后，工作在广州；Java程序员">bradypod's blog</a>.

        <span style="float:right;"><a href="/about.html">关于</a></span>
    
        <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254122988'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1254122988' type='text/javascript'%3E%3C/script%3E"));</script>
        </p>

        <div style="display: block;" id="toTop">
          <a href="#" title="火箭"><i class="icon-arrow-up"></i></a><a href="#footer" title="火箭"><i class="icon-arrow-down"></i></a>
        </div>
    </footer>
    </div><!-- end container -->

  <script type="text/javascript">

    /*入口*/
   var Tetris = (function(){
      var interval, 
          gameOver = false,
          cols = 15,
          rows = 15,
          blockSize = 32,
          speed = 800;

      // Tetris Constructor
      function Tetris(){
        this.board = new Board();
        Keyboard.call(this);
        this.init();
      }
      Tetris.prototype = {
        init: function(){
          this.eventHandlers();
          this.board.init();
        },
        newGame: function(){
          var self = this;
          var sprite = this.board.shape.block.sprite.image;
          sprite.onload = function(){
            self.board.init();
            interval = setInterval(function(){
              self.board.tick();
            }, speed);
          };
        },
        endGame: function(){
          clearInterval(interval);
          clearInterval(this.timer.timerId);
          alert("Game Over");
        }
      };

      // main board
      function Board(){
        var grid;
        this.cols = cols || 13;
        this.rows = rows || 16;
        this.blockSize = blockSize || 32;
        this.canvas = new Canvas('board', cols*blockSize, rows*blockSize);
        this.ctx  = this.canvas.ctx;
        this.shape = new Shape();
        this.list = [];
      }
      Board.prototype = {
        init: function(){
          this.initGrid();
          this.drawGrid();
          this.shape.new().draw(this.ctx);
        },
        initGrid: function(){
          for (var y=0; y < this.rows; y++){
            this.list[y] = [];
            for (var x=0; x < this.cols; x++){
              this.list[y][x] = 0;
            }
          }
        },
        drawGrid: function(){
          this.ctx.strokeStyle = 'rgba(140,140,140,.8)';
          this.ctx.lineWidth = 1;
          
          for(var x=0; x <= this.rows; x++){
            this.ctx.moveTo(0, x * this.blockSize);
            this.ctx.lineTo(this.canvas.width, x * this.blockSize);
            this.ctx.stroke();
          }
          for(var y=0; y <= this.cols; y++){
            this.ctx.moveTo(y * this.blockSize, 0);
            this.ctx.lineTo(y * this.blockSize, this.canvas.height);
            this.ctx.stroke();
          }
        },
        addShapeToBoard: function(){
          console.log(this.shape.layout);
        }
      };//-> end board prototype

      // Shape Constructor
      function Shape(){
        this.block = new Block();
        this.layout;
        this.blockType;
        this.currentX = 0;
        this.currentY = 0;
        this.layouts = [
          [
            [ 0, 1, 0 ],
            [ 1, 1, 1 ]
          ],[
            [ 0, 0, 1 ],
            [ 1, 1, 1 ]
          ],[
            [ 1, 0, 0 ],
            [ 1, 1, 1 ]
          ],[
            [ 1, 1, 0 ],
            [ 0, 1, 1 ]
          ],[
            [ 0, 1, 1 ],
            [ 1, 1, 0 ]
          ],[
            [ 1, 1, 1, 1 ]
          ],[
            [ 1, 1 ],
            [ 1, 1 ]
          ]
        ];
      }
      Shape.prototype = {
        random: function(){
          var layout = this.layouts[ Math.floor(Math.random() * this.layouts.length) ];
          this.blockType = this.block.random();

          for (var y=0; y < layout.length; y++){
            for (var x=0; x < layout[0].length; x++){
              if (layout[y][x]) layout[y][x] = this.blockType;
            }
          }
          this.layout = layout;
        },
        defaultXY: function(){
          this.currentX = Math.floor((cols - this.layout[0].length)/2);
          this.currentY = 0;
          },
        new: function(){
          this.random();
          this.defaultXY();
          return this;
        },
        fixCurrentXY: function(){
          if (this.currentX < 0) this.currentX = 0;
          if (this.currentY < 0) this.currentY = 0;
          if (this.currentX + this.layout[0].length > cols) this.currentX = cols - this.layout[0].length;
          if (this.currentY + this.layout.length    > rows) this.currentY = rows - this.layout.length;
        },
        rotate: function(){
          var newLayout = [];
          for (var y=0; y < this.layout[0].length; y++){
            newLayout[y] = [];
            for (var x=0; x < this.layout.length; x++){
              newLayout[y][x] = this.layout[this.layout.length - 1 - x][y];
            }
          }
          this.layout = newLayout;
          this.fixCurrentXY();
        },
        draw: function(context){                                                                                                                                                                           
          try {
            for (var y=0; y < this.layout.length; y++){
              for (var x=0; x < this.layout[y].length; x++){
                if (this.layout[y][x]) this.block.draw(context, x + this.currentX, y + this.currentY, this.blockType);
              }
            }
          } catch(e){
            console.log("Error: can't draw the shape.");
          }
        }
      };

      // Single Tetris Block
      function Block(){
        this.sprite = new SpriteLoader();
        this.image = this.sprite.image;
        this.size  = this.sprite.imageSize;
        this.total = this.sprite.total;
      }
      Block.prototype = {
        random: function(){
          return Math.floor( Math.random() * this.total ) + 1;
        },
        draw: function(context, x, y, blockType){
          var blockType = blockType || this.random();
          var s = this.size;
          context.drawImage(this.image, (blockType-1)*s, 0, s, s, s*x, s*y, s, s);
        }
      };

      // Sprite Constructor - Loading the sprite image
      function SpriteLoader(src){
        var path = '/static/images/';
        this.image = new Image();
        this.image.src = path + ((src) ? src : 'blocks.png');
        this.imageSize = blockSize || 32;
        this.total = 7;
      }

      // canvas construct
      function Canvas(id, width, height){
        this.id = id;
        this.el = document.getElementById(this.id);
        this.ctx = this.el.getContext('2d');
        this.width  = width  || window.innerWidth  || documentElement.clientWidth;
        this.height = height || window.innerHeight || documentElement.clientHeight;
        this.setSize();
      }
      Canvas.prototype = {
        setSize: function(){
          this.el.width  = this.width;
          this.el.height = this.height;
        },
        clear: function(fromX, fromY, toX, toY){
          var fromX = fromX || 0;
          var fromY = fromY || 0;
          var toX = toX || this.width;
          var toY = toY || this.height;
          this.ctx.clearRect(fromX, fromY, toX, toY);
        },
        drawHeader: function(text, color){
          this.ctx.fillStyle = color;
          this.ctx.fillRect(0, 0, this.width, 50);
          this.ctx.font = "25px Arial";
          this.ctx.fillStyle = 'black';
          this.ctx.textAlign = 'center';
          this.ctx.fillText(text, this.width/2, 34);
        },
        drawText: function(text){
          this.clear(0, 50);
          this.ctx.font = "25px Arial";
          this.ctx.fillStyle = 'white';
          this.ctx.textAlign = 'center';
          this.ctx.fillText(text, this.width/2, 84);
        }
      };

      // 监听键盘
      // Keypress Constructor
      function Keyboard(){
        var self = this;
        var keys = {
          38: 'top',
          39: 'right',
          40: 'down',
          37: 'left'
        };
        this.eventHandlers = function(){
          document.addEventListener('keydown', this.keyPressEvent, true);
        };
        this.keyPressEvent = function(event){
          if (keys[event.keyCode])
            self.keyPress( keys[event.keyCode] );
        };
        this.keyPress = function(key){
          var refresh = false;

          switch(key){
            case 'top':
              this.board.shape.rotate();
          }
            
          if (refresh){
              this.board.refresh();
              this.board.shape.draw(this.board.ctx);
          }
        };
      }

      return new Tetris();
    })();
  </script>

	<script src="/static/js/jquery.min.js"></script>
	<script src="/static/js/bootstrap.min.js"></script>
	<script src="/static/js/prettify.js"></script>
	<script src="/static/js/core.js"></script>
</body>
</html>